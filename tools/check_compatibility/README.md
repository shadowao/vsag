# VSAG Index Compatibility Check Tool

[\[中文\]](README_zh.md)

`check_compatibility` is a command-line utility designed to verify if the current version of the VSAG library can correctly load and use index files generated by an older version. This is crucial for ensuring backward compatibility and is typically used in Continuous Integration (CI) pipelines to prevent breaking changes.

## How It Works

The tool performs the following sequence of operations to validate compatibility:

1.  It accepts a single input argument in the format `<tag>_<algo_name>`.
    -   `<tag>`: Typically a version tag or identifier of an older release (e.g., `v1.0.0`).
    -   `<algo_name>`: The name of the index algorithm (e.g., `hnsw`).
2.  Based on the input argument, it looks for three pre-existing files in the `/tmp/` directory:
    -   An index file (`.index`).
    -   A build configuration file (`_build.json`).
    -   A search configuration file (`_search.json`).
3.  It creates a new index instance using the **current** compiled version of the VSAG library and the parameters from `_build.json`.
4.  It attempts to **deserialize** (load) the old `.index` file into this newly created instance.
5.  If the loading is successful, it performs a sanity check by loading a small test dataset from `/tmp/random_512d_10K.bin` and running a KNN search. This ensures the index is not only structurally compatible but also functionally correct.
6.  If the entire process (loading and search verification) succeeds, it prints a `success` message to standard output. Otherwise, it prints a `failed` message and exits.

## Prerequisites

Before running this tool, you must ensure that the following files exist in the `/tmp/` directory. These files are typically generated by a test script from an older version of the library.

Assuming your input argument is `v1.0.0_hnsw`, you need to prepare:

1.  **Index File**: `/tmp/v1.0.0_hnsw.index`
    -   The `hnsw` index file generated by version `v1.0.0` of the VSAG library.
2.  **Build Config File**: `/tmp/v1.0.0_hnsw_build.json`
    -   Contains the build parameters (in JSON format) used to generate the above index.
3.  **Search Config File**: `/tmp/v1.0.0_hnsw_search.json`
    -   Contains the search parameters (in JSON format) for the sanity check.
4.  **Test Data**: `/tmp/random_512d_10K.bin`
    -   A binary file containing vector data for the search verification.

## Usage

After compiling the `check_compatibility` executable, run it from the command line, providing the target identifier as the sole argument.

```bash
# Compile the tool (assuming you are in the build directory)
# make check_compatibility

# Run the compatibility check
./check_compatibility <tag>_<algo_name>
```

#### Example

To check if the current code is compatible with an `hnsw` index generated by version `v1.0.0`:

```bash
./check_compatibility v1.0.0_hnsw
```

## Output

-   **Success**: If the index loading and search verification pass, the tool will print:
    ```
    v1.0.0_hnsw success
    ```
-   **Failure**: If any step fails, the tool will print to the standard error stream:
    ```
    v1.0.0_hnsw failed
    ```

## License

This tool is licensed under the [Apache License 2.0](http://www.apache.org/licenses/LICENSE-2.0).
